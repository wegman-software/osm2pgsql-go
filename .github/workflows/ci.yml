name: CI

on:
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: home-server-build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out -o=coverage.txt

      - name: Generate coverage report
        id: coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

          # Generate detailed coverage report
          echo "## Test Coverage Report" > coverage-report.md
          echo "" >> coverage-report.md
          echo "**Total Coverage: $COVERAGE**" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "<details>" >> coverage-report.md
          echo "<summary>Coverage by function</summary>" >> coverage-report.md
          echo "" >> coverage-report.md
          echo '```' >> coverage-report.md
          go tool cover -func=coverage.out >> coverage-report.md
          echo '```' >> coverage-report.md
          echo "</details>" >> coverage-report.md

      - name: Comment coverage on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          path: coverage-report.md

  build-docker:
    name: Build Docker Image
    runs-on: home-server-build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: wegmansoftware/osm2pgsql-go:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  validate-pr-title:
    name: Validate PR Title
    runs-on: home-server-build
    steps:
      - name: Validate conventional commit format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^.+$
          subjectPatternError: |
            The subject (title after the type) must not be empty.

  status:
    name: CI Status
    runs-on: home-server-build
    needs: [test, build-docker, validate-pr-title]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          failed=0

          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "::error::Test job failed"
            failed=1
          fi

          if [[ "${{ needs.build-docker.result }}" != "success" ]]; then
            echo "::error::Docker build job failed"
            failed=1
          fi

          if [[ "${{ needs.validate-pr-title.result }}" != "success" ]]; then
            echo "::error::PR title validation failed"
            failed=1
          fi

          if [[ $failed -eq 1 ]]; then
            echo ""
            echo "One or more CI checks failed. See errors above."
            exit 1
          fi

          echo "All CI checks passed!"
